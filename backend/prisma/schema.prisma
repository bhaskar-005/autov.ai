// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model User{
  id                   String          @id @unique @default(uuid())
  username             String
  email                String
  isSuperAdmin         Boolean      @default(false)
  avatar               String

  socialAccountGroups  SocialAccountGroup[]
  uploads              Upload[]

  loginActivity        LoginActivity[]

  youtubeCredentials   YoutubeCredential[]
  facebookCredentials  FacebookCredential[]
  instagramCredentials InstagramCredential[] 
  xCredentials         XCredential[]
  tiktokCredentials    TikTokCredential[]

  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @default(now())
  
}

model LoginActivity {
  id        String    @id @unique @default(uuid())
  ip        String
  device    String
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  createdAt DateTime  @default(now())
}

enum UploadStatus {
  Pending
  InProgress
  Successful
  Failed
}

// project >>
model Upload {
  id                   String           @id @default(cuid())
  uploaderId            String
  uploader             User          @relation(fields: [uploaderId], references: [id])
       
  UploadName           String        @unique
  uploadDescription    String?
  uploadDisplayImage   String
  videoUrl             String
  isAutoGenerated      Boolean       @default(true)

  autoUpload           Boolean       
  uploadTimeStamp      DateTime?
  numberOfClips        Int
        
  groupId              Int
  socialAccountGroup   SocialAccountGroup     @relation(fields: [groupId], references: [id])

  uploadStatus         UploadStatus           @default(Pending) 
  clips                ClipInfo[]

  outbox               Outbox?                 @relation
  speechLanguage       String                 @default("Hindi") 
}

model ClipInfo {
  id                   String           @id @default(cuid())
  uploadId             String           // Foreign key to relate to Upload
  upload               Upload           @relation(fields: [uploadId], references: [id])
  
  clipUrl              String
  clipName             String
  clipDescription      String
  clipTags             String[]

  isUpload             Boolean           @default(false)
  processingStartedAt  DateTime?        // When processing started
  processingCompletedAt DateTime?       // When processing completed
}

enum PlatformEnum {
  Youtube
  Facebook
  X
  TikTok
  Instagram
}
//name space >>
model SocialAccountGroup {
  id                   Int                  @unique @id @default(autoincrement())
  userId               String
  groupUser            User                 @relation(fields: [userId], references: [id])

  groupName            String
  groupDescription     String?
  youtubeCredentials   YoutubeCredential[]
  facebookCredentials  FacebookCredential[]
  instagramCredentials InstagramCredential[]
  tiktokCredentials    TikTokCredential[]
  xCredentials         XCredential[]

  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
                 
  uploads              Upload[]

}


model FacebookCredential {
  id                  String                    @id @default(cuid())
  //reference to the user
  userId              String
  user                User                   @relation(fields: [userId], references: [id])
  
  groupId             Int
  group               SocialAccountGroup      @relation(fields: [groupId], references: [id])
  
  accessToken         String                 // OAuth Access Token for Facebook
  pageId              String                 // Facebook Page ID for the upload
  pageName            String     
  
}

model InstagramCredential {
  id                  String                    @id @default(cuid())
  //reference to the user
  userId              String
  user                User                   @relation(fields: [userId], references: [id])
  
  groupId             Int
  group               SocialAccountGroup      @relation(fields: [groupId], references: [id])

  accessToken         String                 // OAuth Access Token for Instagram
  businessAccountId   String                 // Instagram Business Account ID
  accountName         String
  
}

model YoutubeCredential {
  id                  String                    @id @default(cuid())
  //reference to the user
  userId              String
  user                User                   @relation(fields: [userId], references: [id])
  
  groupId             Int
  group               SocialAccountGroup      @relation(fields: [groupId], references: [id])

  channelCustomUrl      String
  channelName         String
  channelLogo         String

  accessToken         String                 // OAuth Access Token for YouTube
  refreshToken        String?
  accessTokenExpiry   BigInt
}

model XCredential {
  id                  String                    @id @default(cuid())
  userId              String                    // Reference to the user
  user                User                   @relation(fields: [userId], references: [id])

  groupId             Int                    // Reference to the social account group
  group               SocialAccountGroup     @relation(fields: [groupId], references: [id])

  accessToken         String                 // OAuth Access Token for X (formerly Twitter)
  accessTokenSecret   String                 // OAuth Access Token Secret for X
  accountId           String                 // X Account ID

}

model TikTokCredential {
  id                  Int                    @id @default(autoincrement())
  userId              String                    // Reference to the user
  user                User                   @relation(fields: [userId], references: [id])

  groupId             Int                    // Reference to the social account group
  group               SocialAccountGroup     @relation(fields: [groupId], references: [id])

  accessToken         String                 // OAuth Access Token for TikTok
  userIdTikTok        String                 // TikTok User ID
  username            String                 // TikTok Username

  clientKey           String?                // Client Key (optional for some use cases)

  
}

enum EventType {
  GENERATE_CLIPS
  UPLOAD_CLIPS
}

//store outbox for only 30 days
// also sent the video quality free users 480 and for primem users 720 and 1080p

model Outbox {
  id             String        @default(cuid()) @unique
  eventType      EventType
  payload        Json
  uploadId       String        @unique
  upload         Upload        @relation(fields: [uploadId], references: [id])
  //instead of deleting the outbox pattern update the status
  status         UploadStatus  @default(Pending) 
  retryCount     Int           @default(0)
  createdAt      DateTime      @default(now())
  processedAt    DateTime?       
}